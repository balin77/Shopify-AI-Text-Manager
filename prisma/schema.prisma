generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
  lastActivityAt      DateTime? @default(now())
}

model AISettings {
  id                String  @id @default(cuid())
  shop              String  @unique
  huggingfaceApiKey String?
  geminiApiKey      String?
  claudeApiKey      String?
  openaiApiKey      String?
  grokApiKey        String?
  deepseekApiKey    String?
  preferredProvider String  @default("huggingface")
  appLanguage       String  @default("de")
  subscriptionPlan  String  @default("basic") // "free", "basic", "pro", "max"

  // Rate Limiting - Hugging Face
  hfMaxTokensPerMinute   Int? @default(1000000)
  hfMaxRequestsPerMinute Int? @default(100)

  // Rate Limiting - Gemini
  geminiMaxTokensPerMinute   Int? @default(1000000)
  geminiMaxRequestsPerMinute Int? @default(15)

  // Rate Limiting - Claude
  claudeMaxTokensPerMinute   Int? @default(40000)
  claudeMaxRequestsPerMinute Int? @default(5)

  // Rate Limiting - OpenAI
  openaiMaxTokensPerMinute   Int? @default(200000)
  openaiMaxRequestsPerMinute Int? @default(500)

  // Rate Limiting - Grok
  grokMaxTokensPerMinute   Int? @default(100000)
  grokMaxRequestsPerMinute Int? @default(60)

  // Rate Limiting - DeepSeek
  deepseekMaxTokensPerMinute   Int? @default(100000)
  deepseekMaxRequestsPerMinute Int? @default(60)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AIInstructions {
  id   String @id @default(cuid())
  shop String @unique

  // PRODUCTS - All fields available
  productTitleFormat             String? @db.Text
  productTitleInstructions       String? @db.Text
  productDescriptionFormat       String? @db.Text
  productDescriptionInstructions String? @db.Text
  productHandleFormat            String? @db.Text
  productHandleInstructions      String? @db.Text
  productSeoTitleFormat          String? @db.Text
  productSeoTitleInstructions    String? @db.Text
  productMetaDescFormat          String? @db.Text
  productMetaDescInstructions    String? @db.Text
  productAltTextFormat           String? @db.Text
  productAltTextInstructions     String? @db.Text

  // COLLECTIONS - All fields except altText
  collectionTitleFormat             String? @db.Text
  collectionTitleInstructions       String? @db.Text
  collectionDescriptionFormat       String? @db.Text
  collectionDescriptionInstructions String? @db.Text
  collectionHandleFormat            String? @db.Text
  collectionHandleInstructions      String? @db.Text
  collectionSeoTitleFormat          String? @db.Text
  collectionSeoTitleInstructions    String? @db.Text
  collectionMetaDescFormat          String? @db.Text
  collectionMetaDescInstructions    String? @db.Text

  // BLOGS/ARTICLES - All fields except altText
  blogTitleFormat             String? @db.Text
  blogTitleInstructions       String? @db.Text
  blogDescriptionFormat       String? @db.Text
  blogDescriptionInstructions String? @db.Text
  blogHandleFormat            String? @db.Text
  blogHandleInstructions      String? @db.Text
  blogSeoTitleFormat          String? @db.Text
  blogSeoTitleInstructions    String? @db.Text
  blogMetaDescFormat          String? @db.Text
  blogMetaDescInstructions    String? @db.Text

  // PAGES - Title, Description (body), Handle only (no SEO fields)
  pageTitleFormat             String? @db.Text
  pageTitleInstructions       String? @db.Text
  pageDescriptionFormat       String? @db.Text
  pageDescriptionInstructions String? @db.Text
  pageHandleFormat            String? @db.Text
  pageHandleInstructions      String? @db.Text
  pageSeoTitleFormat          String? @db.Text
  pageSeoTitleInstructions    String? @db.Text
  pageMetaDescFormat          String? @db.Text
  pageMetaDescInstructions    String? @db.Text

  // POLICIES - Only body/description is editable
  policyDescriptionFormat       String? @db.Text
  policyDescriptionInstructions String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id            String  @id @default(cuid())
  shop          String
  type          String // "translation", "aiGeneration", "bulkTranslation", "bulkAiGeneration"
  status        String  @default("pending") // "pending", "queued", "running", "completed", "failed", "cancelled"
  resourceType  String? // "product", "collection", "blog", "page"
  resourceId    String? // Shopify GID
  resourceTitle String? // For display purposes
  fieldType     String? // "title", "description", "handle", "seoTitle", "metaDescription", "all"
  targetLocale  String? // For translations
  progress      Int     @default(0) // 0-100
  total         Int? // Total number of items (for bulk operations)
  processed     Int     @default(0) // Number of processed items
  prompt        String? @db.Text // The AI prompt/request sent
  result        String? @db.Text // JSON string with results or error message
  error         String? @db.Text

  // Queue management
  queuePosition   Int? // Position in queue (null if not queued)
  retryCount      Int  @default(0) // Number of retries attempted
  estimatedTokens Int? // Estimated tokens for this task
  provider        String? // AI provider used (huggingface, gemini, claude, openai, grok, deepseek) - for recovery

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime? // Automatic deletion timestamp (set to createdAt + 3 days)

  @@index([shop, status])
  @@index([shop, createdAt])
  @@index([shop, queuePosition])
  @@index([expiresAt])
}

model Product {
  id               String  @id // Shopify GID (e.g., "gid://shopify/Product/123")
  shop             String
  title            String
  descriptionHtml  String? @db.Text
  handle           String
  status           String // "ACTIVE", "DRAFT", "ARCHIVED"
  seoTitle         String?
  seoDescription   String? @db.Text
  featuredImageUrl String?
  featuredImageAlt String?

  // Shopify Metadata
  shopifyUpdatedAt DateTime
  lastSyncedAt     DateTime @default(now())

  // Relations
  // NOTE: Translations are now stored in ContentTranslation table (polymorphic)
  images       ProductImage[]
  options      ProductOption[]
  metafields   ProductMetafield[]

  @@unique([shop, id])
  @@index([shop])
  @@index([shop, status])
  @@index([lastSyncedAt])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url                String
  altText            String? // Primary locale alt-text
  mediaId            String? // Shopify Media ID (gid://shopify/MediaImage/123) for translations
  position           Int?
  altTextModifiedAt  DateTime? // Timestamp when user last modified alt-text (prevents webhook sync overwrite)
  altTextTranslations ProductImageAltTranslation[]

  @@index([productId])
}

model ProductImageAltTranslation {
  id      String       @id @default(cuid())
  imageId String
  image   ProductImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  locale  String // "en", "fr", "es", "it", etc.
  altText String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([imageId, locale])
  @@index([imageId])
  @@index([locale])
}

model ProductOption {
  id        String  @id // Shopify Option ID
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name     String
  position Int
  values   String @db.Text // JSON array

  @@index([productId])
}

model ProductMetafield {
  id        String  @id // Shopify Metafield ID
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  namespace String
  key       String
  value     String @db.Text
  type      String

  @@index([productId])
}

model WebhookLog {
  id        String   @id @default(cuid())
  shop      String
  topic     String // "products/create", "products/update", "products/delete"
  productId String?
  payload   String   @db.Text // Full webhook payload
  processed Boolean  @default(false)
  error     String?  @db.Text
  createdAt DateTime @default(now())

  @@index([shop, topic])
  @@index([processed])
  @@index([createdAt])
}

model WebhookRetry {
  id          String   @id @default(cuid())
  shop        String
  topic       String // Webhook topic (e.g., "products/update")
  payload     String   @db.Text // Full webhook payload as JSON
  attempt     Int      @default(0) // Current retry attempt number
  maxAttempts Int      @default(5) // Maximum retry attempts
  nextRetry   DateTime // When to attempt next retry
  lastError   String?  @db.Text // Last error message
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shop])
  @@index([nextRetry])
  @@index([attempt])
}

// ============================================
// CONTENT MODELS (Collections, Blogs, Pages)
// ============================================

model Collection {
  id              String  @id // Shopify GID (e.g., "gid://shopify/Collection/123")
  shop            String
  title           String
  descriptionHtml String? @db.Text
  handle          String
  seoTitle        String?
  seoDescription  String? @db.Text

  // Shopify Metadata
  shopifyUpdatedAt DateTime
  lastSyncedAt     DateTime @default(now())

  @@unique([shop, id])
  @@index([shop])
  @@index([lastSyncedAt])
}

model Article {
  id             String  @id // Shopify GID (e.g., "gid://shopify/Article/123")
  shop           String
  blogId         String // Shopify Blog GID
  blogTitle      String // For display purposes
  title          String
  body           String? @db.Text
  handle         String
  seoTitle       String?
  seoDescription String? @db.Text

  // Shopify Metadata
  shopifyUpdatedAt DateTime
  lastSyncedAt     DateTime @default(now())

  @@unique([shop, id])
  @@index([shop])
  @@index([shop, blogId])
  @@index([lastSyncedAt])
}

model Page {
  id     String  @id // Shopify GID (e.g., "gid://shopify/Page/123")
  shop   String
  title  String
  body   String? @db.Text
  handle String

  // Shopify Metadata
  shopifyUpdatedAt DateTime
  lastSyncedAt     DateTime @default(now())

  @@unique([shop, id])
  @@index([shop])
  @@index([lastSyncedAt])
}

model ShopPolicy {
  id    String  @id // Shopify GID (e.g., "gid://shopify/ShopPolicy/123")
  shop  String
  title String
  body  String? @db.Text
  type  String // "CONTACT_INFORMATION", "LEGAL_NOTICE", "PRIVACY_POLICY", "REFUND_POLICY", "SHIPPING_POLICY", "TERMS_OF_SERVICE"
  url   String?

  // Shopify Metadata
  lastSyncedAt DateTime @default(now())

  @@unique([shop, id])
  @@index([shop])
  @@index([shop, type])
  @@index([lastSyncedAt])
}

model Menu {
  id     String @id // Shopify GID (e.g., "gid://shopify/Menu/123")
  shop   String
  title  String
  handle String
  items  Json   @db.JsonB // Store the entire menu items structure as JSON

  // Shopify Metadata
  lastSyncedAt DateTime @default(now())

  @@unique([shop, id])
  @@index([shop])
  @@index([lastSyncedAt])
}

model ContentTranslation {
  id String @id @default(cuid())

  // Polymorphic relation (can belong to Product, Collection, Article, Page, or ShopPolicy)
  // NOTE: No foreign key constraints - we handle this polymorphically in code
  resourceId   String // The GID of the parent resource
  resourceType String // "Product", "Collection", "Article", "Page", or "ShopPolicy"

  key    String // "title", "body_html", "body", "description", "handle", "meta_title", "meta_description"
  value  String  @db.Text
  locale String // "en", "fr", "es", "it", etc.
  digest String? // Shopify digest for updates

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceId, key, locale])
  @@index([resourceId, locale])
  @@index([resourceType])
  @@index([locale])
}

// ============================================
// THEME CONTENT MODELS (Background Sync)
// ============================================

model ThemeContent {
  id                  String   @id @default(cuid())
  shop                String
  resourceId          String // Shopify GID
  resourceType        String // "ONLINE_STORE_THEME", "ONLINE_STORE_THEME_JSON_TEMPLATE", etc.
  resourceTypeLabel   String // "Theme Content", "JSON Templates", etc.
  groupId             String // "article", "collection", "product", "misc_cart", etc.
  groupName           String // "Article", "Collection", "Cart", etc.
  groupIcon           String // "üìù", "üìÇ", "üõí", etc.
  translatableContent Json // Array of translatable items with keys and values
  lastSyncedAt        DateTime @default(now())

  @@unique([shop, resourceId, groupId])
  @@index([shop])
  @@index([shop, groupId])
  @@index([lastSyncedAt])
}

model ThemeTranslation {
  id         String  @id @default(cuid())
  shop       String
  resourceId String // Links to ThemeContent
  groupId    String // For faster queries
  key        String // Translation key
  value      String  @db.Text
  locale     String // "en", "fr", "es", "it", etc.
  outdated   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shop, resourceId, groupId, key, locale])
  @@index([shop, resourceId, groupId])
  @@index([shop, groupId, locale]) // For efficient locale-specific group queries
  @@index([locale])
}
